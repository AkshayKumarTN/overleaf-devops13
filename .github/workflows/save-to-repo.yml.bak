name: Save PDF to Repository

on:
  workflow_run:
    workflows: ["Compile LaTeX Document"]
    types:
      - completed

jobs:
  save_pdf:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: true
      
      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          ls -la
      
      - name: Move PDFs to compiled-pdfs folder
        run: |
          mkdir -p compiled-pdfs
          
          find . -name "*.pdf" -type f -exec cp {} compiled-pdfs/ \;
          
          cd compiled-pdfs
          LATEST=$(ls -t main-CL*.pdf 2>/dev/null | head -1)
          if [ ! -z "$LATEST" ]; then
            cp "$LATEST" main-latest.pdf
          fi
          
          COMMIT_COUNT=$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          if [ ! -f CHANGELOG.md ]; then
            echo "# PDF Compilation History" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          {
            echo "## Latest Compilation - CL$COMMIT_COUNT"
            echo "- **Date:** $(date -u)"
            echo "- **Files:** $(ls *.pdf 2>/dev/null | wc -l) PDFs"
            echo ""
          } >> CHANGELOG.md
      
      - name: Commit PDFs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“„ Save compiled PDFs [skip ci]"
          file_pattern: 'compiled-pdfs/*'